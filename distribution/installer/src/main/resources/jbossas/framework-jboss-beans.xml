<deployment xmlns="urn:jboss:bean-deployer:2.0">

  <bean name="OSGiFrameworkProperties" class="org.jboss.osgi.framework.plugins.internal.FrameworkPropertiesImpl">
    <constructor>
      <parameter>
        <map keyClass="java.lang.String" valueClass="java.lang.String">
          <entry><key>org.osgi.framework.storage</key><value>${jboss.server.data.dir}/osgi-store</value></entry>
          <entry><key>org.osgi.framework.storage.clean</key><value>onFirstInit</value></entry>
          <entry><key>org.osgi.framework.system.packages.extra</key><value>
            
            <!-- javax -->
            javax.servlet,            
            javax.servlet.http,            
            javax.transaction,
            
            <!-- jnp naming -->
            org.jnp.interfaces;version=5.0,
            
            <!-- logging -->
            org.apache.log4j;version=1.2,
            org.jboss.logging;version=2.1,
            
            <!-- jboss -->
            org.jboss.beans.metadata.plugins;version=2.2,
            org.jboss.beans.metadata.plugins.builder;version=2.2,
            org.jboss.beans.metadata.spi;version=2.2,
            org.jboss.beans.metadata.spi.builder;version=2.2,
            org.jboss.dependency.spi;version=2.2,
            org.jboss.kernel.spi.dependency;version=2.2,
            
            <!-- jboss-osgi -->
            org.jboss.osgi.spi;version=1.0,
            org.jboss.osgi.spi.capability;version=1.0,
            org.jboss.osgi.spi.framework;version=1.0,
            org.jboss.osgi.spi.service;version=1.0,
            org.jboss.osgi.spi.util;version=1.0,
            org.jboss.osgi.testing;version=1.0,
            org.jboss.osgi.vfs;version=1.0
          </value></entry>
          <!-- Husky socket connector properties -->
          <entry><key>org.jboss.osgi.husky.runtime.connector.host</key><value>${jboss.bind.address}</value></entry>
          <entry><key>org.jboss.osgi.husky.runtime.connector.port</key><value>5401</value></entry>
          <!-- HTTP Service Port -->
          <entry><key>org.osgi.service.http.port</key><value>8090</value></entry>
          <!-- Config Admin Service -->
          <entry><key>felix.cm.dir</key><value>${jboss.server.data.dir}/osgi-configadmin</value></entry>
          <!-- JMX bundle properties -->
          <entry><key>org.jboss.osgi.jmx.host</key><value>${jboss.bind.address}</value></entry>
          <!-- JNDI bundle properties -->
          <entry><key>org.jboss.osgi.jndi.host</key><value>${jboss.bind.address}</value></entry>
          <!-- JTA Object Store -->
          <entry><key>com.arjuna.ats.arjuna.objectstore.objectStoreDir</key><value>${jboss.server.data.dir}/tx-object-store</value></entry>
          <!-- Enable Workaround for [JBOSGI-317] Context is already registered in domain DefaultDomain -->
          <entry><key>jbosgi317.workaround</key><value>true</value></entry>
          <!-- Enable Workaround for [JBOSGI-319] LinkageError for the type javax/servlet/Servlet -->
          <entry><key>jbosgi319.workaround</key><value>true</value></entry>
        </map>
      </parameter>
    </constructor>
  </bean>
  
  <!-- [JBOSGI-147] Autostart in JBossAS recycle the bundle
  <bean name="OSGiAutoInstallPlugin" class="org.jboss.osgi.framework.plugins.internal.AutoInstallPluginImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
    <property name="autoInstall">
     <list elementClass="java.net.URL">
      <value>${jboss.server.home.dir}/deploy/osgi/org.osgi.compendium.jar</value>
     </list>
    </property>
    <property name="autoStart">
     <list elementClass="java.net.URL">
      <value>${jboss.server.home.dir}/deploy/osgi/org.apache.felix.log.jar</value>
      <value>${jboss.server.home.dir}/deploy/osgi/jboss-osgi-common.jar</value>
     </list>
    </property>
  </bean>
  -->

  <bean name="MicrocontainerService" class="org.jboss.osgi.framework.service.internal.MicrocontainerServiceImpl">
    <related-class name="org.jboss.osgi.spi.service.MicrocontainerService">OSGi</related-class>
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
    <demand state="PreInstall">MDRService</demand>
  </bean>
  
  <bean name="OSGiBundleResolver" class="org.jboss.osgi.framework.resolver.internal.basic.BasicResolverImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>

  <bean name="OSGiDeployersWrapper" class="org.jboss.osgi.framework.deployers.OSGiDeployersWrapper" >
    <constructor>
      <parameter><inject bean="MainDeployer"/></parameter>
      <parameter><inject bean="OSGiBundleManager"/></parameter>
    </constructor>
  </bean>

  <!-- Enable Workaround for [JBOSGI-317] Context is already registered in domain DefaultDomain -->
  <bean name="OSGiModuleDeployerJBOSGI317" class="org.jboss.osgi.framework.deployers.OSGiModuleDeployerWorkaround">
    <property name="classLoading"><inject bean="ClassLoading" /></property>
    <property name="bundleManager"><inject bean="OSGiBundleManager" /></property>
  </bean>

  <!-- Autostart the Framework -->
  <bean name="jboss.osgi:service=Framework" class="org.jboss.osgi.framework.launch.OSGiFramework">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
    <depends>OSGiFrameworkEventsPlugin</depends>
    <depends>OSGiServiceManagerPlugin</depends>
    <depends>OSGiStoragePlugin</depends>
    <depends>OSGiSystemPackages</depends>
  </bean>
  
</deployment>