<deployment xmlns="urn:jboss:bean-deployer:2.0">

  <!-- $Id: $ -->

  <!-- 
  ********************************
  *                              *  
  *  OSGi Bundle Manager         *
  *                              *
  ********************************
  -->
  
  <bean name="OSGiBundleManager" class="org.jboss.osgi.framework.bundle.OSGiBundleManager">
    <constructor>
      <parameter><inject bean="jboss.kernel:service=Kernel" /></parameter>
      <parameter><inject bean="MainDeployer" /></parameter>
    </constructor>
    <property name="properties">
      <map keyClass="java.lang.String" valueClass="java.lang.String">
        <entry><key>org.osgi.framework.storage</key><value>${jboss.server.data.dir}/osgi-store</value></entry>
        <entry><key>org.osgi.framework.storage.clean</key><value>onFirstInit</value></entry>
        <entry><key>org.osgi.framework.system.packages.extra</key><value>
          
          <!-- jnp naming -->
          org.jnp.interfaces,
          org.jnp.server,
          
          <!-- logging -->
          org.apache.log4j;version=1.2,
          org.jboss.logging;version=2.1,
          
          <!-- jboss -->
          org.jboss.beans.metadata.plugins;version=2.2,
          org.jboss.beans.metadata.plugins.builder;version=2.2,
          org.jboss.beans.metadata.spi;version=2.2,
          org.jboss.beans.metadata.spi.builder;version=2.2,
          org.jboss.dependency.spi;version=2.2,
          org.jboss.kernel.spi.dependency;version=2.2,
          
          <!-- jboss-osgi -->
          org.jboss.osgi.spi;version=1.0,
          org.jboss.osgi.spi.capability;version=1.0,
          org.jboss.osgi.spi.framework;version=1.0,
          org.jboss.osgi.spi.management;version=1.0,
          org.jboss.osgi.spi.service;version=1.0,
          org.jboss.osgi.spi.util;version=1.0
        </value></entry>
        <!-- Husky socket connector properties -->
        <entry><key>org.jboss.osgi.husky.runtime.connector.host</key><value>${jboss.bind.address}</value></entry>
        <entry><key>org.jboss.osgi.husky.runtime.connector.port</key><value>5401</value></entry>
        <!-- HTTP Service Port -->
        <entry><key>org.osgi.service.http.port</key><value>8090</value></entry>
        <!-- Config Admin Service -->
        <entry><key>felix.cm.dir</key><value>${jboss.server.data.dir}/osgi-configadmin</value></entry>
        <!-- JMX bundle properties -->
        <entry><key>org.jboss.osgi.jmx.host</key><value>${jboss.bind.address}</value></entry>
        <entry><key>org.jboss.osgi.jmx.port</key><value>1098</value></entry>
        <!-- JNDI bundle properties -->
        <entry><key>org.jboss.osgi.jndi.host</key><value>${jboss.bind.address}</value></entry>
        <entry><key>org.jboss.osgi.jndi.rmi.port</key><value>1098</value></entry>
        <entry><key>org.jboss.osgi.jndi.port</key><value>1099</value></entry>
        <!-- JTA Object Store -->
        <entry><key>com.arjuna.ats.arjuna.objectstore.objectStoreDir</key><value>${jboss.server.data.dir}/tx-object-store</value></entry>
      </map>
    </property>
    <incallback method="addPlugin" />
    <uncallback method="removePlugin" />
  </bean>
  
  <!-- 
  ********************************
  *                              *  
  *  OSGi Manager Plugins        *
  *                              *
  ********************************
  -->

  <!-- [JBOSGI-147] Autostart in JBossAS recycle the bundle
  <bean name="OSGiAutoInstallPlugin" class="org.jboss.osgi.framework.plugins.internal.AutoInstallPluginImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
    <property name="autoInstall">
     <list elementClass="java.net.URL">
      <value>${jboss.server.home.dir}/deploy/osgi/org.osgi.compendium.jar</value>
     </list>
    </property>
    <property name="autoStart">
     <list elementClass="java.net.URL">
      <value>${jboss.server.home.dir}/deploy/osgi/org.apache.felix.log.jar</value>
      <value>${jboss.server.home.dir}/deploy/osgi/jboss-osgi-common.jar</value>
     </list>
    </property>
  </bean>
  -->

  <bean name="OSGiControllerContextPlugin" class="org.jboss.osgi.framework.bundle.ControllerContextPluginImpl">
    <constructor>
      <parameter><inject bean="OSGiBundleManager" /></parameter>
      <parameter><inject bean="OSGiDeploymentRegistry" /></parameter>
    </constructor>
  </bean>
  <bean name="OSGiBundleResolver" class="org.jboss.osgi.framework.resolver.internal.basic.BasicResolverImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="OSGiFrameworkEventsPlugin" class="org.jboss.osgi.framework.plugins.internal.FrameworkEventsPluginImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="OSGiServiceManager" class="org.jboss.osgi.framework.bundle.ServiceManagerPluginImpl">
    <constructor>
      <parameter><inject bean="OSGiBundleManager" /></parameter>
      <parameter><inject bean="OSGiDeploymentRegistry" /></parameter>
    </constructor>
    <property name="enableMDRUsage">false</property>
  </bean>
  <bean name="OSGiStoragePlugin" class="org.jboss.osgi.framework.plugins.internal.BundleStoragePluginImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="OSGiSystemPackages" class="org.jboss.osgi.framework.plugins.internal.SystemPackagesPluginImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>

  <!-- 
  ********************************
  *                              *  
  *  OSGi Service Plugins        *
  *                              *
  ********************************
  -->
  
  <bean name="MicrocontainerService" class="org.jboss.osgi.framework.service.internal.MicrocontainerServiceImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="StartLevelService" class="org.jboss.osgi.framework.service.internal.StartLevelImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="PackageAdminService" class="org.jboss.osgi.framework.packageadmin.PackageAdminImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="DeployerService" class="org.jboss.osgi.framework.service.internal.DeployerServiceImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="LifecycleInterceptorService" class="org.jboss.osgi.framework.service.internal.LifecycleInterceptorServiceImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  
  <!--
  ********************************
  *                              *  
  *  OSGi Interceptors           *
  *                              *
  ********************************
  -->
  
  <bean name="WebXMLVerifier" class="org.jboss.osgi.framework.service.internal.WebXMLVerifierInterceptor">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  
  <!--
  ********************************
  *                              *  
  *  OSGi Deployment             *
  *                              *
  ********************************
  -->
  
  <bean name="OSGiDeploymentRegistry" class="org.jboss.deployers.structure.spi.helpers.AbstractDeploymentRegistry"/>

  <bean name="OSGiDeployersWrapper" class="org.jboss.osgi.framework.deployers.OSGiDeployersWrapper" >
    <constructor>
      <parameter><inject bean="MainDeployer"/></parameter>
      <parameter><inject bean="OSGiBundleManager"/></parameter>
    </constructor>
  </bean>

  <bean name="OSGiBundleActivatorDeployer" class="org.jboss.osgi.framework.deployers.OSGiBundleActivatorDeployer" />
  <bean name="OSGiBundleStateAddDeployer" class="org.jboss.osgi.framework.deployers.OSGiBundleStateAddDeployer">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="OSGiBundleStateRemoveDeployer" class="org.jboss.osgi.framework.deployers.OSGiBundleStateRemoveDeployer">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="OSGiBundleStructure" class="org.jboss.osgi.deployer.BundleStructureDeployer" />
  <bean name="OSGiContextTrackerDeployer" class="org.jboss.osgi.framework.deployers.OSGiContextTrackerDeployer" />
  <bean name="OSGiManifestParsingDeployer" class="org.jboss.osgi.framework.deployers.OSGiManifestParsingDeployer" />
  <bean name="OSGiNativeCodeMetaDataDeployer" class="org.jboss.osgi.framework.deployers.OSGiNativeCodeMetaDataDeployer" />

  <!--
  ********************************
  *                              *  
  *  OSGi Classloading           *
  *                              *
  ********************************
  -->
  
  <bean name="OSGiClassLoading" class="org.jboss.osgi.framework.classloading.OSGiClassLoading"/>
  <bean name="OSGiClassLoaderSystem" class="org.jboss.osgi.framework.classloading.OSGiClassLoaderSystem" />
  <bean name="OSGiClassLoaderDomain" class="org.jboss.osgi.framework.classloading.OSGiClassLoaderDomain" >
    <constructor><parameter>OSGiClassLoaderDomain</parameter></constructor>
    <property name="classLoaderSystem"><inject bean="OSGiClassLoaderSystem"/></property>
    <property name="bundleManager"><inject bean="OSGiBundleManager" /></property>
  </bean>
  <bean name="OSGiClassLoaderFactory" class="org.jboss.osgi.framework.classloading.OSGiClassLoaderFactory" >
    <property name="system"><inject bean="OSGiClassLoaderSystem"/></property>
  </bean>
  <bean name="OSGiClassLoadingDeployer" class="org.jboss.osgi.framework.deployers.OSGiBundleClassLoadingDeployer">
    <property name="domain"><inject bean="OSGiClassLoaderDomain"/></property>
    <property name="factory"><inject bean="OSGiClassLoaderFactory"/></property>
  </bean>
  <bean name="OSGiFragmentClassLoadingDeployer" class="org.jboss.osgi.framework.deployers.OSGiFragmentClassLoadingDeployer">
    <property name="domain"><inject bean="OSGiClassLoaderDomain"/></property>
    <property name="factory"><inject bean="OSGiClassLoaderFactory"/></property>
  </bean>
  <bean name="OSGiFragmentAttachmentDeployer" class="org.jboss.osgi.framework.deployers.OSGiFragmentAttachmentDeployer"/>
  <bean name="OSGiModuleDeployer" class="org.jboss.osgi.framework.deployers.OSGiModuleDeployerTempWorkaround">
    <property name="classLoading"><inject bean="OSGiClassLoading" /></property>
  </bean>
   
  <!-- 
  ********************************
  *                              *  
  *  Framework                   *
  *                              *
  ********************************
  -->
  
  <bean name="jboss.osgi:service=Framework" class="org.jboss.osgi.framework.launch.OSGiFramework">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  
</deployment>